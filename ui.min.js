/**
 * 日历插件
 */

define("sys.ui.datePicker",function (req, exp) {
	"use strict";

exp.getTemplate = function($){var buf = [];
buf.push('﻿');
var today = this.today;    var selected = this.selected; var maxDate = this.maxDate; var minDate = this.minDate;
buf.push('<div class="sk-calendar" style="background:#fff;width:350px;">	<div class="sk-calendar-ymbar">		<p class="sk-calendar-left" data-event="goPrevMonth"></p>		<div class="sk-calendar-ym">			<select class="sk-calendar-ylist" data-event="change>setYear">				');
 for (var i=today.year-100; i<=today.year+50; i++){ 
buf.push('					<option value="');
buf.push(i);
buf.push('" ');
if(i==this.year){
buf.push(' selected="selected" ');
}
buf.push('>');
buf.push(i);
buf.push('年</option>				');
 } 
buf.push('			</select>			<select class="sk-calendar-mlist" data-event="change>setMonth">				');
 for(var i=1; i<=12; i++){ 
buf.push('				<option value="');
buf.push(i);
buf.push('" ');
if(i==this.month){
buf.push(' selected="selected" ');
}
buf.push('>');
buf.push(i);
buf.push('月</option>				');
 } 
buf.push('			</select>		</div>		<p class="sk-calendar-right" data-event="goNextMonth"></p>	</div>	<ul class="sk-calendar-xq"><li>周日</li><li>周一</li><li>周二</li><li>周三</li><li>周四</li><li>周五</li><li>周六</li></ul>    ');
    	var dayHTML = [];		for(var i=1; i<=this.day; i++){			dayHTML.push('<li>&nbsp;</li>');		}        for(var i=1; i<=this.days; i++){
        var dateTimes = new Date(this.year+"/"+this.month+"/"+i).getTime();
        if(maxDate!=0&&maxDate<dateTimes){
        dayHTML.push('<li class="cantSet" ');}
        else if(minDate!=0&&minDate>dateTimes){dayHTML.push('<li class="cantSet" ');}
        else{dayHTML.push('<li data-event="setDate" ');}       if(selected.year==this.year&&selected.month==this.month&&selected.date==i){        		dayHTML.push(' class="selectedday"');        	}else if(today.year==this.year&&today.month==this.month&&today.date==i){        		dayHTML.push(' class="today"');        	}        	dayHTML.push('>'+i+'</li>');        } 		dayHTML = dayHTML.join("");
buf.push('    <ul class="sk-calendar-dlist">');
buf.push(dayHTML);
buf.push('</ul></div>');
return buf.join("");};


    var str = req('sys.string');
    var date = req("sys.date");
	
	var dt = new Date();
	exp.today = {
		year: dt.getFullYear(),
		month: dt.getMonth() + 1,
		date: dt.getDate()
	};

    exp.selected = {}; //选中
	//	box: document.body,
	exp.year = exp.today.year;
	exp.month = exp.today.month;
	exp.date = exp.today.date;

    exp.maxDate = 0;
    exp.minDate = 0;
    //选中
    exp.select = function($element, onDateChange){
        exp.input = $element;
        exp.onDateChange = onDateChange;
        exp.show();
        exp.draw();
    };
	
	//设置年份
	exp.setYear = function(){
		exp.year = +exp.element.value;
        exp.date = 0;
		exp.draw();
	};

    //设置月份
    exp.setMonth = function () {
        exp.month = +exp.element.value;
        exp.date = 0;
        exp.draw();
    };

    //设置日期
    exp.setDate = function () {
        exp.selected.year = exp.year;
        exp.selected.month = exp.month;
        exp.selected.date = +exp.element.innerHTML;
        exp.draw();
        if(exp.input){
            var dateStr = str.format("{year}/{month}/{date}", exp.selected);
            dateStr = date.format(dateStr, "yyyy-MM-dd");
            exp.input.val(dateStr);
            exp.onDateChange && exp.onDateChange(exp.input.attr("dateType"),dateStr);
			exp.hide();
        }
    };

    //跳到上一个月
    exp.goPrevMonth = function(){
        var month = exp.month - 1;
        if(month<1){
			exp.year -= 1;
            month = 12;
        }
        exp.month = month;
        exp.draw();
    };

    //跳到下一个月
    exp.goNextMonth = function(){
        var month = exp.month + 1;
        if(month>12){
            exp.year += 1;
            month = 1;
        }
        exp.month = month;
        exp.draw();
    };

	//设置日期
	exp.setDayAndDays = function () {
        exp.day = new Date(exp.year, exp.month - 1, 1).getDay();
        exp.days = new Date(exp.year, exp.month, 0).getDate();
	};
	exp.setDayAndDays();

	//绘制
	exp.draw = function () {
        exp.setDayAndDays();
        exp.canSetDate();
		exp.render();
        exp.ui.style.top = exp.input.position().top+exp.ui.offsetHeight+exp.input.height()+30+"px";
        exp.ui.style.left = exp.input.position().left+exp.ui.offsetWidth+exp.input.width()-110+"px";
        exp.ui.style.position = "absolute";
	};

    exp.canSetDate = function(){
        var maxDate = exp.input.attr("max");
        var minDate = exp.input.attr("min");
        if(maxDate&&maxDate!=""){
            exp.minDate = 0;
            exp.maxDate = date.parseDate(maxDate).getTime();
        }
        if(minDate&&minDate!=""){
            exp.maxDate = 0;
            exp.minDate = date.parseDate(minDate).getTime();
        }
        if(maxDate==undefined&&minDate==undefined){
            exp.maxDate = 0;
            exp.minDate = 0;
        }
        if(maxDate==undefined)exp.maxDate = 0;
        if(minDate==undefined)exp.minDate = 0;
    };
});
